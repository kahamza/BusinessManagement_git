# ğŸ† Loyalty & Discounts System

<div dir="rtl">

# ğŸ† Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ„Ø§Ø¡ ÙˆØ§Ù„ØªØ®ÙÙŠØ¶Ø§Øª

</div>

## ğŸ“‹ Overview | Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

The Loyalty & Discounts system is designed to enhance customer engagement and boost sales through various reward mechanisms and promotional offers. It includes a points-based loyalty program, dynamic discount rules, and promotional campaigns.

<div dir="rtl">

## ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

ØµÙÙ…Ù… Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ„Ø§Ø¡ ÙˆØ§Ù„ØªØ®ÙÙŠØ¶Ø§Øª Ù„ØªØ¹Ø²ÙŠØ² Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Ø®Ù„Ø§Ù„ Ø¢Ù„ÙŠØ§Øª Ù…ÙƒØ§ÙØ¢Øª Ù…Ø®ØªÙ„ÙØ© ÙˆØ¹Ø±ÙˆØ¶ ØªØ±ÙˆÙŠØ¬ÙŠØ©. ÙŠØªØ¶Ù…Ù† Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆÙ„Ø§Ø¡ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø®ØµÙ… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ÙˆØ­Ù…Ù„Ø§Øª ØªØ±ÙˆÙŠØ¬ÙŠØ©.

</div>

## ğŸ¯ Key Features | Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

### 1. Loyalty Program
- **Points Earning**: Customers earn points for purchases
- **Tiered Membership**: Multiple membership levels (e.g., Silver, Gold, Platinum)
- **Point Redemption**: Convert points to discounts or free items
- **Birthday Rewards**: Special offers on customer birthdays
- **Referral Program**: Reward for referring new customers

### 2. Discount System
- **Percentage-based Discounts**
- **Fixed Amount Discounts**
- **Buy X Get Y Free**
- **Bulk Purchase Discounts**
- **Time-based Promotions**

### 3. Campaign Management
- **Targeted Promotions**
- **Seasonal Sales**
- **Flash Sales**
- **Coupon Codes**
- **Bundle Offers**

### 4. Analytics & Reporting
- **Redemption Tracking**
- **Customer Engagement Metrics**
- **ROI Analysis**
- **Promotion Performance**

<div dir="rtl">

## ğŸ¯ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

### 1. Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ÙˆÙ„Ø§Ø¡
- **ÙƒØ³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·**: ÙŠØ­ØµÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
- **Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©**: Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© (Ù…Ø«Ù„ Ø§Ù„ÙØ¶ÙŠØŒ Ø§Ù„Ø°Ù‡Ø¨ÙŠØŒ Ø§Ù„Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ)
- **Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·**: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¥Ù„Ù‰ Ø®ØµÙˆÙ…Ø§Øª Ø£Ùˆ Ø¹Ù†Ø§ØµØ± Ù…Ø¬Ø§Ù†ÙŠØ©
- **Ù…ÙƒØ§ÙØ¢Øª Ø£Ø¹ÙŠØ§Ø¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯**: Ø¹Ø±ÙˆØ¶ Ø®Ø§ØµØ© ÙÙŠ Ø£Ø¹ÙŠØ§Ø¯ Ù…ÙŠÙ„Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
- **Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©**: Ù…ÙƒØ§ÙØ¢Øª Ù„Ø¥Ø­Ø§Ù„Ø© Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø¯Ø¯

### 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª
- **Ø®ØµÙˆÙ…Ø§Øª Ø¨Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©**
- **Ø®ØµÙˆÙ…Ø§Øª Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª**
- **Ø§Ø´ØªØ±ÙŠ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ù…Ø¬Ø§Ù†Ù‹Ø§**
- **Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø§Ù„Ø¬Ù…Ù„Ø©**
- **Ø¹Ø±ÙˆØ¶ Ù„ÙØªØ±Ø© Ù…Ø­Ø¯ÙˆØ¯Ø©**

### 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª
- **Ø¹Ø±ÙˆØ¶ Ù…Ø³ØªÙ‡Ø¯ÙØ©**
- **ØªØ®ÙÙŠØ¶Ø§Øª Ù…ÙˆØ³Ù…ÙŠØ©**
- **Ø¹Ø±ÙˆØ¶ Ø®Ø§Ø·ÙØ©**
- **Ø£ÙƒÙˆØ§Ø¯ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª**
- **Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª**

### 4. Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
- **ØªØªØ¨Ø¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„**
- **Ù…Ù‚Ø§ÙŠÙŠØ³ ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡**
- **ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±**
- **Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©**

</div>

## ğŸ—ï¸ Architecture | Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©

### System Components
```mermaid
graph TD
    A[Customer] -->|Earns/Spends| B[Loyalty Points]
    B -->|Affects| C[Customer Tier]
    D[Promotion Engine] -->|Applies| E[Discounts]
    E -->|Impacts| F[Sales]
    F -->|Generates| B
    G[Analytics] -->|Analyzes| H[Campaign Performance]
    H -->|Optimizes| D
```

### Data Flow
1. Customer makes a purchase
2. System calculates points based on purchase amount
3. Points are added to customer's loyalty account
4. Customer tier is updated if threshold is met
5. Available discounts are applied to future purchases
6. Campaign performance is tracked and analyzed

<div dir="rtl">

## ğŸ—ï¸ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©

### Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
```mermaid
graph TD
    A[Ø§Ù„Ø¹Ù…ÙŠÙ„] -->|ÙŠÙƒØ³Ø¨/ÙŠÙ†ÙÙ‚| B[Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙ„Ø§Ø¡]
    B -->|ØªØ¤Ø«Ø± Ø¹Ù„Ù‰| C[Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ù…ÙŠÙ„]
    D[Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¹Ø±ÙˆØ¶] -->|ÙŠØ·Ø¨Ù‚| E[Ø®ØµÙˆÙ…Ø§Øª]
    E -->|ØªØ¤Ø«Ø± Ø¹Ù„Ù‰| F[Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª]
    F -->|ØªÙˆÙ„Ø¯| B
    G[Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª] -->|ØªØ­Ù„Ù„| H[Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©]
    H -->|ØªØ­Ø³Ù†| D
```

### ØªØ¯ÙÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
1. ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡
2. ÙŠØ­Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ø±Ø§Ø¡
3. ØªÙØ¶Ø§Ù Ø§Ù„Ù†Ù‚Ø§Ø· Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ ÙˆÙ„Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„
4. ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹ØªØ¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
5. ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©
6. ÙŠØªÙ… ØªØªØ¨Ø¹ ÙˆØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø§Øª

</div>

## ğŸ›  Implementation | Ø§Ù„ØªÙ†ÙÙŠØ°

### 1. Database Schema

#### Loyalty Program
```kotlin
@Entity(tableName = "loyalty_programs")
data class LoyaltyProgram(
    @PrimaryKey(autoGenerate = true)
    val programId: Long = 0,
    val name: String,
    val description: String?,
    val isActive: Boolean = true,
    val pointsPerCurrency: Double = 1.0, // Points per 1 currency unit
    val pointsExpiryDays: Int? = null, // Null means never expire
    val minPurchaseAmount: Double = 0.0,
    val createdAt: Long = System.currentTimeMillis(),
    val updatedAt: Long = System.currentTimeMillis()
)

@Entity(tableName = "loyalty_tiers")
data class LoyaltyTier(
    @PrimaryKey(autoGenerate = true)
    val tierId: Long = 0,
    val programId: Long,
    val name: String,
    val description: String?,
    val minPoints: Long,
    val benefits: List<LoyaltyBenefit>,
    val isActive: Boolean = true,
    val createdAt: Long = System.currentTimeMillis()
)

data class LoyaltyBenefit(
    val type: BenefitType,
    val value: Double,
    val description: String
)

enum class BenefitType {
    POINTS_MULTIPLIER,    // Earn X times more points
    DISCOUNT_PERCENTAGE,  // X% discount on purchases
    DISCOUNT_AMOUNT,     // Fixed amount discount
    FREE_SHIPPING,       // Free shipping
    BIRTHDAY_REWARD,     // Special reward on birthday
    EARLY_ACCESS,        // Early access to sales
    EXCLUSIVE_OFFERS     // Exclusive member offers
}
```

### 2. Discount Rules Engine

#### Rule Definition
```kotlin
interface DiscountRule {
    val ruleId: String
    val name: String
    val description: String?
    val isActive: Boolean
    val priority: Int
    val validFrom: Long?
    val validTo: Long?
    val appliesTo: DiscountAppliesTo
    
    fun isApplicable(context: DiscountContext): Boolean
    fun calculateDiscount(context: DiscountContext): DiscountResult
}

data class DiscountContext(
    val customer: Customer?,
    val items: List<OrderItem>,
    val orderTotal: Double,
    val orderDate: Long = System.currentTimeMillis(),
    val appliedCoupons: List<String> = emptyList()
)

data class DiscountResult(
    val discountAmount: Double,
    val description: String,
    val appliedRule: DiscountRule,
    val affectedItems: List<OrderItem> = emptyList()
)

enum class DiscountAppliesTo {
    ENTIRE_ORDER,
    CHEAPEST_ITEM,
    MOST_EXPENSIVE_ITEM,
    SPECIFIC_CATEGORY,
    SPECIFIC_PRODUCT,
    CUSTOM_SELECTION
}
```

#### Example Rules
```kotlin
// Percentage discount for loyalty members
class LoyaltyTierDiscount(
    override val ruleId: String = "loyalty_tier_discount",
    override val name: String = "Loyalty Tier Discount",
    override val description: String = "Discount based on customer loyalty tier",
    override val isActive: Boolean = true,
    override val priority: Int = 10,
    private val tierDiscounts: Map<String, Double> = mapOf(
        "GOLD" to 0.10,   // 10% off for Gold members
        "PLATINUM" to 0.15 // 15% off for Platinum members
    )
) : DiscountRule {
    
    override val validFrom: Long? = null
    override val validTo: Long? = null
    override val appliesTo: DiscountAppliesTo = DiscountAppliesTo.ENTIRE_ORDER
    
    override fun isApplicable(context: DiscountContext): Boolean {
        val customer = context.customer ?: return false
        val loyaltyTier = customer.loyaltyTier ?: return false
        return tierDiscounts.containsKey(loyaltyTier)
    }
    
    override fun calculateDiscount(context: DiscountContext): DiscountResult {
        val loyaltyTier = context.customer?.loyaltyTier ?: return DiscountResult.ZERO
        val discountRate = tierDiscounts[loyaltyTier] ?: return DiscountResult.ZERO
        
        val discountAmount = context.orderTotal * discountRate
        
        return DiscountResult(
            discountAmount = discountAmount,
            description = "${discountRate * 100}% ${loyaltyTier.capitalize()} Member Discount",
            appliedRule = this,
            affectedItems = context.items
        )
    }
}

// Buy X Get Y Free
class BuyXGetYFree(
    override val ruleId: String,
    override val name: String,
    override val description: String?,
    override val isActive: Boolean,
    override val priority: Int,
    override val validFrom: Long?,
    override val validTo: Long?,
    val buyQuantity: Int,
    val getQuantity: Int,
    val appliesTo: DiscountAppliesTo,
    val productIds: List<Long>? = null,
    val categoryIds: List<Long>? = null
) : DiscountRule {
    
    override fun isApplicable(context: DiscountContext): Boolean {
        // Check if the promotion is active
        val now = System.currentTimeMillis()
        if (validFrom != null && now < validFrom) return false
        if (validTo != null && now > validTo) return false
        
        // Check if the rule applies to any items in the cart
        return when (appliesTo) {
            DiscountAppliesTo.ENTIRE_ORDER -> true
            DiscountAppliesTo.SPECIFIC_PRODUCT -> 
                context.items.any { item -> productIds?.contains(item.productId) == true }
            DiscountAppliesTo.SPECIFIC_CATEGORY -> 
                context.items.any { item -> categoryIds?.contains(item.categoryId) == true }
            else -> false
        }
    }
    
    override fun calculateDiscount(context: DiscountContext): DiscountResult {
        val applicableItems = when (appliesTo) {
            DiscountAppliesTo.ENTIRE_ORDER -> context.items
            DiscountAppliesTo.SPECIFIC_PRODUCT -> 
                context.items.filter { productIds?.contains(it.productId) == true }
            DiscountAppliesTo.SPECIFIC_CATEGORY -> 
                context.items.filter { categoryIds?.contains(it.categoryId) == true }
            else -> return DiscountResult.ZERO
        }
        
        // Group items by product to handle quantities
        val itemGroups = applicableItems.groupBy { it.productId }
        var totalDiscount = 0.0
        val affectedItems = mutableListOf<OrderItem>()
        
        for ((_, items) in itemGroups) {
            val totalQuantity = items.sumOf { it.quantity }
            val freeItems = (totalQuantity / (buyQuantity + getQuantity)) * getQuantity
            
            if (freeItems > 0) {
                val itemPrice = items.first().price
                totalDiscount += freeItems * itemPrice
                affectedItems.addAll(items.take(freeItems.toInt()))
            }
        }
        
        return if (totalDiscount > 0) {
            DiscountResult(
                discountAmount = totalDiscount,
                description = "Buy $buyQuantity Get $getQuantity Free",
                appliedRule = this,
                affectedItems = affectedItems
            )
        } else {
            DiscountResult.ZERO
        }
    }
}
```

### 3. Loyalty Points Calculation

```kotlin
class LoyaltyPointsCalculator {
    
    fun calculateEarnedPoints(
        order: Order,
        customer: Customer?,
        loyaltyProgram: LoyaltyProgram
    ): Int {
        if (!loyaltyProgram.isActive) return 0
        if (order.total < loyaltyProgram.minPurchaseAmount) return 0
        
        val basePoints = (order.subtotal * loyaltyProgram.pointsPerCurrency).toInt()
        
        // Apply tier multiplier if applicable
        val multiplier = customer?.loyaltyTier?.let { tier ->
            loyaltyProgram.tiers.find { it.tierId == tier.tierId }?.benefits
                ?.find { it.type == BenefitType.POINTS_MULTIPLIER }
                ?.value ?: 1.0
        } ?: 1.0
        
        return (basePoints * multiplier).toInt()
    }
    
    fun applyPointsRedemption(
        customer: Customer,
        pointsToRedeem: Int,
        orderTotal: Double
    ): RedemptionResult {
        if (customer.loyaltyPoints < pointsToRedeem) {
            return RedemptionResult.Error("Insufficient points")
        }
        
        val pointValue = calculatePointValue(customer)
        val discountAmount = pointsToRedeem * pointValue
        
        // Cap the discount at order total
        val actualDiscount = minOf(discountAmount, orderTotal)
        val pointsUsed = (actualDiscount / pointValue).toInt()
        
        return RedemptionResult.Success(
            pointsUsed = pointsUsed,
            discountAmount = actualDiscount,
            remainingPoints = customer.loyaltyPoints - pointsUsed
        )
    }
    
    private fun calculatePointValue(customer: Customer): Double {
        // Could be based on customer tier or other factors
        return 0.01 // 1 point = $0.01 by default
    }
    
    sealed class RedemptionResult {
        data class Success(
            val pointsUsed: Int,
            val discountAmount: Double,
            val remainingPoints: Int
        ) : RedemptionResult()
        
        data class Error(val message: String) : RedemptionResult()
    }
}
```

## ğŸ§ª Testing | Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±

### 1. Unit Tests for Discount Rules
```kotlin
@ExperimentalCoroutinesApi
class DiscountRuleTest {
    
    private lateinit var loyaltyTierDiscount: LoyaltyTierDiscount
    private lateinit var buyXGetYFree: BuyXGetYFree
    private lateinit var testProducts: List<Product>
    
    @Before
    fun setup() {
        loyaltyTierDiscount = LoyaltyTierDiscount()
        
        buyXGetYFree = BuyXGetYFree(
            ruleId = "test_buy1_get1",
            name = "Buy 1 Get 1 Free",
            description = "Buy 1 item, get 1 free",
            isActive = true,
            priority = 5,
            validFrom = null,
            validTo = null,
            buyQuantity = 1,
            getQuantity = 1,
            appliesTo = DiscountAppliesTo.SPECIFIC_PRODUCT,
            productIds = listOf(1L, 2L)
        )
        
        testProducts = listOf(
            Product(id = 1, name = "Test Product 1", price = 10.0, categoryId = 1),
            Product(id = 2, name = "Test Product 2", price = 20.0, categoryId = 1),
            Product(id = 3, name = "Test Product 3", price = 30.0, categoryId = 2)
        )
    }
    
    @Test
    fun `loyalty tier discount applies to eligible customers`() {
        val goldCustomer = Customer(
            id = 1,
            name = "Gold Member",
            loyaltyTier = "GOLD",
            loyaltyPoints = 1000
        )
        
        val context = createTestContext(goldCustomer)
        
        assertTrue(loyaltyTierDiscount.isApplicable(context))
        
        val result = loyaltyTierDiscount.calculateDiscount(context)
        
        assertEquals(10.0, result.discountAmount) // 10% of 100.0
        assertEquals("10.0% Gold Member Discount", result.description)
    }
    
    @Test
    fun `buy 1 get 1 free calculates correct discount`() {
        val items = listOf(
            OrderItem(productId = 1, quantity = 2, unitPrice = 10.0, name = "Test Product 1"),
            OrderItem(productId = 3, quantity = 1, unitPrice = 30.0, name = "Test Product 3")
        )
        
        val context = createTestContext(items = items)
        
        assertTrue(buyXGetYFree.isApplicable(context))
        
        val result = buyXGetYFree.calculateDiscount(context)
        
        assertEquals(10.0, result.discountAmount) // 1 free item worth 10.0
        assertEquals(1, result.affectedItems.size)
    }
    
    private fun createTestContext(
        customer: Customer? = null,
        items: List<OrderItem> = listOf(
            OrderItem(productId = 1, quantity = 1, unitPrice = 10.0, name = "Test Product 1"),
            OrderItem(productId = 2, quantity = 2, unitPrice = 20.0, name = "Test Product 2")
        )
    ): DiscountContext {
        return DiscountContext(
            customer = customer,
            items = items,
            orderTotal = items.sumOf { it.unitPrice * it.quantity }
        )
    }
}
```

### 2. Integration Tests
```kotlin
@HiltAndroidTest
class LoyaltyIntegrationTest {
    
    @get:Rule
    val hiltRule = HiltAndroidRule(this)
    
    @Inject
    lateinit var loyaltyRepository: LoyaltyRepository
    
    @Inject
    lateinit var database: AppDatabase
    
    @Before
    fun setup() {
        hiltRule.inject()
    }
    
    @After
    fun cleanup() {
        database.close()
    }
    
    @Test
    fun `customer earns points on purchase`() = runTest {
        // Given
        val customer = Customer(
            id = 1,
            name = "Test Customer",
            loyaltyPoints = 100
        )
        
        val order = Order(
            id = "ORDER-123",
            customerId = customer.id,
            subtotal = 100.0,
            tax = 10.0,
            total = 110.0,
            status = OrderStatus.COMPLETED
        )
        
        val program = LoyaltyProgram(
            programId = 1,
            name = "Standard Program",
            pointsPerCurrency = 1.0,
            minPurchaseAmount = 0.0
        )
        
        // When
        val pointsEarned = loyaltyRepository.calculatePointsEarned(order, customer, program)
        
        // Then
        assertEquals(100, pointsEarned) // 100 * 1.0 points per currency
    }
    
    @Test
    fun `points redemption applies correct discount`() = runTest {
        // Given
        val customer = Customer(
            id = 1,
            name = "Test Customer",
            loyaltyPoints = 1000
        )
        
        // When
        val result = loyaltyRepository.redeemPoints(customer, 500, 200.0)
        
        // Then
        assertTrue(result is RedemptionResult.Success)
        val success = result as RedemptionResult.Success
        assertEquals(500, success.pointsUsed)
        assertEquals(5.0, success.discountAmount) // 500 * 0.01
        assertEquals(500, success.remainingPoints)
    }
}
```

## ğŸš€ Deployment | Ø§Ù„Ù†Ø´Ø±

### 1. Configuration
```yaml
# app-config.yaml
loyalty:
  points:
    enabled: true
    pointsPerCurrency: 1.0
    minPurchaseAmount: 0.0
    expirationDays: 365
    
discounts:
  rules:
    - type: loyalty_tier
      enabled: true
      priority: 10
      tiers:
        - name: SILVER
          minPoints: 0
          discountPercentage: 5.0
        - name: GOLD
          minPoints: 1000
          discountPercentage: 10.0
        - name: PLATINUM
          minPoints: 5000
          discountPercentage: 15.0
    
    - type: buy_x_get_y
      enabled: true
      priority: 5
      name: "Buy 1 Get 1 Free"
      description: "Buy one item, get one free"
      buyQuantity: 1
      getQuantity: 1
      appliesTo: specific_products
      productIds: [1, 2, 3]
      validFrom: null
      validTo: null
```

### 2. Feature Flags
```kotlin
object FeatureFlags {
    // Enable/disable loyalty program
    const val LOYALTY_PROGRAM_ENABLED = true
    
    // Enable/disable specific discount types
    const val DISCOUNT_PERCENTAGE_ENABLED = true
    const val DISCOUNT_AMOUNT_ENABLED = true
    const val BUY_X_GET_Y_ENABLED = true
    
    // Maximum discount that can be applied as percentage of order total
    const val MAX_DISCOUNT_PERCENTAGE = 50.0
    
    // Maximum points that can be redeemed in a single transaction
    const val MAX_POINTS_REDEMPTION = 10000
}
```

## ğŸ“ Conclusion | Ø§Ù„Ø®Ø§ØªÙ…Ø©

The Loyalty & Discounts system provides a flexible and powerful way to engage customers and drive sales. With support for multiple discount types, tiered loyalty programs, and comprehensive analytics, it helps businesses build long-term customer relationships while maximizing revenue.

<div dir="rtl">

## ğŸ“ Ø§Ù„Ø®Ø§ØªÙ…Ø©

ÙŠÙˆÙØ± Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ„Ø§Ø¡ ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø·Ø±ÙŠÙ‚Ø© Ù…Ø±Ù†Ø© ÙˆÙ‚ÙˆÙŠØ© Ù„Ø¥Ø´Ø±Ø§Ùƒ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª. Ù…Ø¹ Ø¯Ø¹Ù… Ø£Ù†ÙˆØ§Ø¹ Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ù† Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙˆØ¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙˆÙ„Ø§Ø¡ Ø§Ù„Ù…ØªØ¯Ø±Ø¬Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©ØŒ ÙÙ‡Ùˆ ÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø¹Ù„Ù‰ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ø§Ù‚Ø§Øª Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ø£Ù…Ø¯ Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¹ ØªØ¹Ø¸ÙŠÙ… Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª.

</div>

## ğŸ“š Related Documents | Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø°Ø§Øª Ø§Ù„ØµÙ„Ø©

1. [Customer Management](./03-customers.md)
2. [POS System](./01-pos.md)
3. [Inventory Management](./02-inventory.md)
4. [Analytics & Reporting](../analytics/01-overview.md)

## ğŸ™‹ Support | Ø§Ù„Ø¯Ø¹Ù…

For support, please contact our development team or open an issue in the repository.

<div dir="rtl">

## ğŸ™‹ Ø§Ù„Ø¯Ø¹Ù…

Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¹Ù…ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø£Ùˆ ÙØªØ­ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹.

</div>
